<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Online Card Game Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #050816;
      --card: #0f172a;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-danger: #ef4444;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --radius: 14px;
      --shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 24px;
    }

    h1 {
      font-size: 2.1rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 span.logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background: radial-gradient(circle, #22c55e, #16a34a);
      color: #020617;
      font-weight: 900;
      font-size: 1.1rem;
      box-shadow: var(--shadow);
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
      margin-bottom: 18px;
      line-height: 1.45;
    }

    .subtitle strong { color: var(--accent); }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: var(--radius);
      padding: 16px 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .badge {
      font-size: 0.72rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(34, 197, 94, 0.5);
      white-space: nowrap;
    }

    .small {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 10px;
    }

    input {
      width: 100%;
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-main);
      font-size: 0.9rem;
      outline: none;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3);
    }

    .row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .row > div { flex: 1; min-width: 220px; }

    button {
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.88rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #020617;
      box-shadow: 0 14px 30px rgba(34, 197, 94, 0.35);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }

    button.secondary {
      background: rgba(148, 163, 184, 0.15);
      color: var(--text-main);
      box-shadow: none;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 16px 35px rgba(34, 197, 94, 0.4); }
    button.secondary:hover { box-shadow: 0 12px 25px rgba(15, 23, 42, 0.8); }
    button:disabled { opacity: 0.55; cursor: default; transform: none; box-shadow: none; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
    }

    .state-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .state-item {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      font-size: 0.86rem;
    }

    .state-label {
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .state-value {
      margin-top: 3px;
      font-weight: 800;
      color: var(--accent);
      overflow-wrap: anywhere;
    }

    .hand-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .card-chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.35), rgba(15, 23, 42, 0.95));
      font-size: 0.9rem;
      font-weight: 800;
      user-select: none;
      cursor: pointer;
    }

    .card-chip:hover {
      border-color: rgba(34, 197, 94, 0.75);
      transform: translateY(-1px);
    }

    .log {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid var(--border);
      font-size: 0.85rem;
      max-height: 260px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .log-line { margin-bottom: 6px; }
    .log-line .time { color: var(--text-muted); margin-right: 8px; }
    .log-line .ok { color: var(--accent); font-weight: 800; }
    .log-line .err { color: var(--accent-danger); font-weight: 800; }

    .hint {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(2, 6, 23, 0.65);
      border: 1px dashed rgba(148, 163, 184, 0.25);
      color: var(--text-muted);
      font-size: 0.86rem;
      line-height: 1.45;
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 700px) { .split { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <header>
    <h1><span class="logo">CG</span> Online Card Game ‚Äì Admin Panel</h1>
    <p class="subtitle">
      Real-time ready backend demo for <strong>2-player card battle</strong>.
      <br/>
      <strong>Authors:</strong> ABDULRAUF ALSIAD &amp; OMAR ABDELSALAM MAHROUS ABDELMOTLEB
    </p>
  </header>

  <main class="layout">

    <!-- LEFT: SAME "ADMIN" STYLE, BUT ONE-FIELD FLOW -->
    <section class="card">
      <h2>
        Quick Setup (One Field / Device)
        <span class="badge">No Player ID Input</span>
      </h2>

      <p class="small">
        Device #1: enter your name and leave Game ID empty ‚Üí creates game and becomes <b>Player 1</b>.
        <br/>
        Device #2: enter your name and type the same Game ID ‚Üí joins and becomes <b>Player 2</b>.
      </p>

      <div class="split">
        <div>
          <label>Your Name</label>
          <input id="nameInput" placeholder="e.g. ABDULRAUF" />
        </div>
        <div>
          <label>Game ID (empty = create new)</label>
          <input id="gameInput" placeholder="e.g. 1" />
        </div>
      </div>

      <div class="row">
        <div>
          <button onclick="createOrJoin()">üéÆ Create / Join</button>
        </div>
        <div>
          <button class="secondary" onclick="resetAll()">üßπ Reset Device</button>
        </div>
      </div>

      <div class="row">
        <div class="pill"><span class="dot"></span> <span id="rolePill">Role: ‚Äì</span></div>
        <div class="pill"><span class="dot"></span> <span id="sessionPill">Session: Not joined</span></div>
      </div>

      <div class="hint">
        ‚úÖ You will create your player only once on this device.
        After that, the ID is saved automatically in the browser (LocalStorage).<br/>
        ‚úÖ Click a card from your hand to auto-fill the ‚ÄúPlay Card‚Äù box.
      </div>
    </section>

    <!-- RIGHT: LIVE GAME STATUS (LIKE THE FIRST UI) -->
    <section class="card">
      <h2>
        Live Game Status
        <span class="badge" id="statusBadge">No game</span>
      </h2>

      <div class="state-grid">
        <div class="state-item">
          <div class="state-label">My Player ID</div>
          <div class="state-value" id="myPlayerId">‚Äì</div>
        </div>
        <div class="state-item">
          <div class="state-label">My Role</div>
          <div class="state-value" id="myRole">‚Äì</div>
        </div>
        <div class="state-item">
          <div class="state-label">Game ID</div>
          <div class="state-value" id="myGameId">‚Äì</div>
        </div>
        <div class="state-item">
          <div class="state-label">Round</div>
          <div class="state-value" id="myRound">‚Äì</div>
        </div>
        <div class="state-item">
          <div class="state-label">Status</div>
          <div class="state-value" id="myStatus">‚Äì</div>
        </div>
        <div class="state-item">
          <div class="state-label">Tip</div>
          <div class="state-value" style="color:#f9fafb; font-weight:700;">Play a card & wait opponent</div>
        </div>
      </div>

      <label style="margin-top:12px;">My Hand</label>
      <div class="hand-badges" id="handBox"></div>

      <label style="margin-top:12px;">Play Card (example: QH, 10C, AS)</label>
      <div class="row">
        <div><input id="cardInput" placeholder="Card code" /></div>
        <div><button onclick="playCard()">‚ñ∂ Play</button></div>
      </div>

      <div class="row">
        <div><button class="secondary" onclick="loadHand()">üÉè Get Hand</button></div>
        <div><button class="secondary" onclick="refreshGame()">üîÑ Refresh State</button></div>
      </div>

      <div class="log" id="logBox"></div>
    </section>

  </main>

  <script>
    // ‚úÖ Put your Render URL here (no trailing slash)
    const BASE_URL = "https://card-game-backend-5yi3.onrender.com";

    const LS = {
      playerId: "cg_player_id",
      gameId: "cg_game_id",
      role: "cg_role",
      name: "cg_name"
    };

    function log(message, type = "ok") {
      const box = document.getElementById("logBox");
      const line = document.createElement("div");
      line.className = "log-line";
      const t = new Date().toLocaleTimeString();
      const label = type === "err" ? '<span class="err">ERROR</span>' : '<span class="ok">OK</span>';
      line.innerHTML = `<span class="time">[${t}]</span>${label} ${message}`;
      box.appendChild(line);
      box.scrollTop = box.scrollHeight;
    }

    async function api(path, options = {}) {
      const res = await fetch(BASE_URL + path, {
        headers: { "Content-Type": "application/json" },
        ...options
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw data;
      return data;
    }

    function setPills(roleText, sessionText) {
      document.getElementById("rolePill").textContent = `Role: ${roleText || "‚Äì"}`;
      document.getElementById("sessionPill").textContent = `Session: ${sessionText || "Not joined"}`;
    }

    function setLive({ playerId, role, gameId, round, status }) {
      document.getElementById("myPlayerId").textContent = playerId ?? "‚Äì";
      document.getElementById("myRole").textContent = role ?? "‚Äì";
      document.getElementById("myGameId").textContent = gameId ?? "‚Äì";
      document.getElementById("myRound").textContent = round ?? "‚Äì";
      document.getElementById("myStatus").textContent = status ?? "‚Äì";
      document.getElementById("statusBadge").textContent = gameId ? `Game #${gameId}` : "No game";
    }

    function renderHand(cards) {
      const box = document.getElementById("handBox");
      box.innerHTML = "";
      (cards || []).forEach(c => {
        const chip = document.createElement("div");
        chip.className = "card-chip";
        chip.textContent = c;
        chip.onclick = () => {
          document.getElementById("cardInput").value = c;
        };
        box.appendChild(chip);
      });
    }

    async function createPlayerIfNeeded(name) {
      const existing = localStorage.getItem(LS.playerId);
      if (existing) return parseInt(existing, 10);

      const p = await api("/players", {
        method: "POST",
        body: JSON.stringify({ name })
      });

      localStorage.setItem(LS.playerId, String(p.player_id));
      localStorage.setItem(LS.name, name);
      log(`Created player "${p.name}" (ID ${p.player_id}).`, "ok");
      return p.player_id;
    }

    async function createOrJoin() {
      try {
        const name = (document.getElementById("nameInput").value || "").trim();
        if (!name) { log("Please enter your name.", "err"); return; }

        const myPlayerId = await createPlayerIfNeeded(name);

        let gidText = (document.getElementById("gameInput").value || "").trim();
        let gameId = gidText ? parseInt(gidText, 10) : null;

        // Create game if empty
        if (!gameId) {
          const g = await api("/games", { method: "POST" });
          gameId = g.game_id;
          document.getElementById("gameInput").value = gameId;
          log(`Created new game (ID ${gameId}).`, "ok");
        }

        // Join game (server decides if allowed)
        await api(`/games/${gameId}/join`, {
          method: "POST",
          body: JSON.stringify({ player_id: myPlayerId })
        });

        localStorage.setItem(LS.gameId, String(gameId));
        setPills(localStorage.getItem(LS.role) || "‚Äì", `Joined game ${gameId}`);

        // Determine role automatically by reading game state
        const st = await api(`/games/${gameId}`);
        const ids = (st.players || []).map(x => x.player_id);
        const idx = ids.indexOf(myPlayerId);
        const role = idx === 0 ? "Player 1" : (idx === 1 ? "Player 2" : "Player");

        localStorage.setItem(LS.role, role);
        setPills(role, `Joined game ${gameId}`);

        setLive({
          playerId: myPlayerId,
          role,
          gameId,
          round: st.current_round,
          status: st.status
        });

        log(`Joined game ${gameId} as ${role}.`, "ok");
        await loadHand();
      } catch (e) {
        log(`Create/Join failed: ${JSON.stringify(e)}`, "err");
      }
    }

    async function loadHand() {
      try {
        const pid = parseInt(localStorage.getItem(LS.playerId) || "0", 10);
        const gid = parseInt(localStorage.getItem(LS.gameId) || "0", 10);
        if (!pid || !gid) { log("No active session. Create/Join first.", "err"); return; }

        const data = await api(`/games/${gid}/hand/${pid}`);
        renderHand(data.hand || []);
        log(`Hand loaded (${(data.hand || []).length} cards).`, "ok");
      } catch (e) {
        log(`Load hand failed: ${JSON.stringify(e)}`, "err");
      }
    }

    async function playCard() {
      try {
        const pid = parseInt(localStorage.getItem(LS.playerId) || "0", 10);
        const gid = parseInt(localStorage.getItem(LS.gameId) || "0", 10);
        const card = (document.getElementById("cardInput").value || "").trim().toUpperCase();

        if (!pid || !gid) { log("No active session. Create/Join first.", "err"); return; }
        if (!card) { log("Enter a card code (or click a card).", "err"); return; }

        const res = await api(`/games/${gid}/play`, {
          method: "POST",
          body: JSON.stringify({ player_id: pid, card_code: card })
        });

        document.getElementById("cardInput").value = "";

        if (res.message) {
          log(res.message, "ok");
        } else {
          const w = (res.winner === null || typeof res.winner === "undefined") ? "DRAW" : `Player ${res.winner}`;
          log(`Round finished. Winner: ${w}.`, "ok");
        }

        // show removal immediately (works if backend removes played cards)
        await loadHand();
        await refreshGame();
      } catch (e) {
        log(`Play failed: ${JSON.stringify(e)}`, "err");
      }
    }

    async function refreshGame() {
      try {
        const gid = parseInt(localStorage.getItem(LS.gameId) || "0", 10);
        const pid = parseInt(localStorage.getItem(LS.playerId) || "0", 10);
        if (!gid) { log("No game to refresh.", "err"); return; }

        const st = await api(`/games/${gid}`);

        setLive({
          playerId: pid || null,
          role: localStorage.getItem(LS.role) || "‚Äì",
          gameId: gid,
          round: st.current_round,
          status: st.status
        });

        log("Game state refreshed.", "ok");
      } catch (e) {
        log(`Refresh failed: ${JSON.stringify(e)}`, "err");
      }
    }

    function resetAll() {
      localStorage.removeItem(LS.playerId);
      localStorage.removeItem(LS.gameId);
      localStorage.removeItem(LS.role);
      localStorage.removeItem(LS.name);

      document.getElementById("nameInput").value = "";
      document.getElementById("gameInput").value = "";
      document.getElementById("cardInput").value = "";
      document.getElementById("logBox").innerHTML = "";
      renderHand([]);

      setPills("‚Äì", "Not joined");
      setLive({ playerId: null, role: null, gameId: null, round: null, status: null });

      log("Device session reset. Create/Join again.", "ok");
    }

    // Boot: load saved values
    (function boot() {
      const savedName = localStorage.getItem(LS.name);
      const savedGid = localStorage.getItem(LS.gameId);
      const savedPid = localStorage.getItem(LS.playerId);
      const savedRole = localStorage.getItem(LS.role);

      if (savedName) document.getElementById("nameInput").value = savedName;
      if (savedGid) document.getElementById("gameInput").value = savedGid;

      if (savedPid && savedGid) {
        setPills(savedRole || "‚Äì", `Joined game ${savedGid}`);
        setLive({
          playerId: parseInt(savedPid, 10),
          role: savedRole || "‚Äì",
          gameId: parseInt(savedGid, 10),
          round: "‚Äì",
          status: "‚Äì"
        });
        refreshGame();
        loadHand();
        log("Loaded saved session for this device.", "ok");
      } else {
        setPills("‚Äì", "Not joined");
      }
    })();
  </script>
</body>
</html>
